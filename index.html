<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Palestrante Ideal</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f5f3ff;
      --bg2: #ede9fe;
      --surface: #ffffff;
      --border: rgba(124, 58, 237, 0.15);
      --accent: #7c3aed;
      --accent2: #5b21b6;
      --accent-glow: rgba(124, 58, 237, 0.2);
      --text: #1e1030;
      --text-muted: #6b5b8a;
      --user-bubble: #7c3aed;
      --ai-bubble: #ffffff;
      --yellow: #f59e0b;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-weight: 400;
      overflow: hidden;
    }

    /* Subtle background grain */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: none;
      pointer-events: none;
      z-index: 0;
    }

    .layout {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 860px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0 16px;
      border-bottom: 1px solid rgba(124, 58, 237, 0.12);
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 18px;
      color: white;
      letter-spacing: -1px;
    }

    .logo-text {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 17px;
      letter-spacing: -0.3px;
    }

    .logo-text span {
      color: var(--accent);
    }

    .header-tag {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 20px;
    }

    /* CHAT AREA */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 28px 0 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scrollbar-width: thin;
      scrollbar-color: var(--surface) transparent;
    }

    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--surface); border-radius: 4px; }

    /* Welcome state */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      padding: 40px 20px;
      animation: fadeUp 0.6s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 24px;
      box-shadow: 0 0 40px var(--accent-glow);
    }

    .welcome h1 {
      font-family: 'Syne', sans-serif;
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }

    .welcome h1 span { color: var(--accent); }

    .welcome p {
      color: var(--text-muted);
      font-size: 15px;
      max-width: 420px;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 560px;
    }

    .chip {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(124, 58, 237, 0.06);
    }

    /* Messages */
    .message {
      display: flex;
      gap: 12px;
      animation: fadeUp 0.3s ease both;
    }

    .message.user { flex-direction: row-reverse; }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Syne', sans-serif;
    }

    .avatar.ai {
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      color: white;
    }

    .avatar.user-av {
      background: var(--user-bubble);
      border: none;
      color: #ffffff;
    }

    .bubble {
      max-width: 72%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14.5px;
      line-height: 1.65;
    }

    .message.ai .bubble {
      background: var(--ai-bubble);
      border: 1px solid var(--border);
      border-top-left-radius: 4px;
      color: var(--text);
      box-shadow: 0 2px 8px rgba(124,58,237,0.08);
    }

    .message.user .bubble {
      background: var(--user-bubble);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-top-right-radius: 4px;
      color: #ffffff;
    }

    .bubble strong { color: var(--accent); font-weight: 600; }
    .bubble em { color: var(--text-muted); font-style: normal; }

    /* Typing indicator */
    .typing {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      animation: fadeUp 0.3s ease both;
    }

    .typing-dots {
      background: var(--ai-bubble);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-top-left-radius: 4px;
      padding: 14px 18px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.4;
      animation: blink 1.2s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.4; transform: scale(1); }
      40% { opacity: 1; transform: scale(1.2); }
    }

    /* INPUT AREA */
    .input-area {
      padding: 16px 0 24px;
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: var(--surface);
      border: 1.5px solid rgba(124, 58, 237, 0.2);
      border-radius: 16px;
      padding: 10px 10px 10px 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 12px rgba(124,58,237,0.08);
    }

    .input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    #userInput {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14.5px;
      font-weight: 300;
      resize: none;
      max-height: 140px;
      min-height: 24px;
      line-height: 1.5;
    }

    #userInput::placeholder { color: var(--text-muted); }

    #sendBtn {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: opacity 0.2s, transform 0.15s;
    }

    #sendBtn:hover { opacity: 0.9; transform: scale(1.05); }
    #sendBtn:active { transform: scale(0.96); }
    #sendBtn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    #sendBtn svg { width: 16px; height: 16px; fill: white; }

    .input-hint {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 10px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
<div class="layout">
  <header>
    <div class="logo">
      <div class="logo-mark">PI</div>
      <div class="logo-text">Palestrante <span>Ideal</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="header-tag">Consultor de Palestras</div>
      <button id="restartBtn" onclick="restartChat()" style="display:none;background:none;border:1px solid rgba(124,58,237,0.2);color:var(--text-muted);font-size:11px;font-weight:500;letter-spacing:0.06em;text-transform:uppercase;padding:4px 10px;border-radius:20px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='rgba(124,58,237,0.2)';this.style.color='var(--text-muted)'">â†º RecomeÃ§ar</button>
    </div>
  </header>

  <div class="chat-area" id="chatArea">
    <div class="welcome" id="welcome">
      <div class="welcome-icon">ðŸŽ¤</div>
      <h1>Encontre o palestrante <span>ideal</span></h1>
      <p>Sou seu consultor de palestras. Me conte sobre seu evento e vou sugerir os melhores palestrantes para o seu objetivo e orÃ§amento.</p>
      <div class="suggestion-chips">
        <div class="chip" onclick="sendChip(this)">Preciso de um palestrante motivacional</div>
        <div class="chip" onclick="sendChip(this)">Evento para empresa em SÃ£o Paulo</div>
        <div class="chip" onclick="sendChip(this)">SugestÃµes para datas especiais</div>
        <div class="chip" onclick="sendChip(this)">Bons palestrantes atÃ© R$ 30.000</div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea id="userInput" placeholder="Descreva seu evento ou faÃ§a uma pergunta..." rows="1"></textarea>
      <button id="sendBtn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
    <p class="input-hint">Palestrante Ideal Â· Consultoria de Palestras Corporativas</p>
  </div>
</div>

<script>
  // â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var SUPABASE_URL = 'https://jmgkaeiynkklbnkgwimb.supabase.co';
  var SUPABASE_KEY = 'sb_publishable_gdIe5v55isrPCHoXFqEuIw_FOPFBRvl';

  var EMAILJS_SERVICE  = 'service_m09nl3n';
  var EMAILJS_TEMPLATE = 'template_suld3q8';
  var EMAILJS_PUBLIC   = 'LGrr9Eg3a0LHS2tIg';

  const SYSTEM_PROMPT = `VocÃª Ã© um Consultor de Agendamento de Palestras do Palestrante Ideal, uma agÃªncia especializada em palestrantes corporativos.

Seu objetivo Ã© ajudar organizadores de eventos a encontrar o palestrante ideal e estruturar o pedido de forma profissional. Seja profissional e objetivo. NÃ£o invente dados. NÃ£o pressione o cliente.

SOBRE OS PALESTRANTES:
VocÃª tem acesso a uma base com centenas de palestrantes brasileiros. Quando sugerir nomes, use os dados fornecidos. Se o palestrante nÃ£o estiver na base, sinalize que irÃ¡ atrÃ¡s do contato e valor do cachÃª, e mandarÃ¡ por email.

REGRAS OBRIGATÃ“RIAS:
1. Responda a primeira pergunta normalmente e em seguida peÃ§a um resumo do evento que o cliente estÃ¡ planejando.
2. Ao informar cachÃªs, cite sempre o valor mais alto disponÃ­vel no banco de dados, citando "em torno de", e arredondando o nÃºmero para um nÃºmero cheio, terminado em zero.
3. Priorize indicar palestrantes Premium e Super Premium, desde que encaixem no orÃ§amento do cliente.
4. Se nÃ£o encontrar o valor do cachÃª no banco de dados, diga que irÃ¡ entrar em contato para descobrir e retornar por email (peÃ§a o email e todas as informaÃ§Ãµes para fazer a confirmaÃ§Ã£o de orÃ§amento).
5. Sempre que citar um palestrante ou agÃªncia, diga que tem o contato direto e pode negociar diretamente.

Depois de indicar palestrantes e obter ok do cliente, avance para a CONFIRMAÃ‡ÃƒO DE ORÃ‡AMENTO preenchendo as informaÃ§Ãµes coletadas ao longo da conversa:
- Nome, empresa, e-mail e telefone do cliente
- Data (ou perÃ­odo estimado) do evento e local
- Resumo do evento
- Palestrante(s) desejado(s)
- OrÃ§amento disponÃ­vel

QUANDO TIVER TODAS AS INFORMAÃ‡Ã•ES, apresente:

ðŸ”Ž CONFIRMAÃ‡ÃƒO DE ORÃ‡AMENTO

Empresa:
ResponsÃ¡vel:
E-mail:
Telefone:
Data do evento:
Local:
Resumo do evento:
Investimento previsto:

Depois escreva: "Por favor, revise as informaÃ§Ãµes. Se estiver tudo correto, responda **CONFIRMO** para que possamos seguir com a formalizaÃ§Ã£o."

QUANDO O CLIENTE RESPONDER "CONFIRMO":
Responda exatamente: "Perfeito. Agora Ã© comigo â€” vou atrÃ¡s do seu orÃ§amento completo e te mando e-mail assim que estiver tudo pronto. ðŸŽ¯"

Em seguida, inclua no final da sua resposta o marcador especial: ##SEND_EMAIL##[RESUMO COMPLETO AQUI]##END_EMAIL##`;

  // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  emailjs.init(EMAILJS_PUBLIC);

  let history = [];
  let speakerCache = null;

  // â”€â”€â”€ LOAD SPEAKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSpeakers() {
    if (speakerCache) return speakerCache;
    var qResult = await sbClient
      .from('Palestrantes')
      .select('Nome, "Mini Bio", "Temas/Categorias", Instagram, "AgÃªncia(s)", "URL Perfil", "CachÃª", "Tier de Mercado", "ObservaÃ§Ã£o"');
    if (qResult.error) { console.error('Supabase error:', qResult.error); return []; }
    speakerCache = qResult.data;
    return speakerCache;
  }

  // Busca por mÃºltiplos termos com score de relevÃ¢ncia
  function searchSpeakers(query, speakers) {
    if (!speakers || !query) return [];
    const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 2);
    return speakers
      .map(s => {
        const text = ((s['Nome'] || '') + ' ' + (s['Temas/Categorias'] || '') + ' ' + (s['Mini Bio'] || '')).toLowerCase();
        const score = terms.reduce((acc, t) => acc + (text.includes(t) ? 1 : 0), 0);
        return { ...s, _score: score };
      })
      .filter(s => s._score > 0)
      .sort((a, b) => b._score - a._score)
      .slice(0, 12);
  }

  // Formatar palestrante para contexto
  function formatSpeaker(s) {
    const cache = s['CachÃª'] ? s['CachÃª'] : 'NAO DISPONIVEL';
    const tier = s['Tier de Mercado'] || '';
    return `â€¢ NOME: ${s.Nome} | TIER: ${tier} | CACHE EXATO: ${cache} | Temas: ${s['Temas/Categorias'] || '-'} | ${(s['Mini Bio'] || '').substring(0, 120)}`;
  }

  // Detectar nomes prÃ³prios na mensagem (palavras com inicial maiÃºscula, 2+ letras)
  function extractProperNames(text) {
    const words = text.split(/\s+/);
    const names = [];
    for (let i = 0; i < words.length; i++) {
      const w = words[i].replace(/[^a-zA-ZÃ€-Ãº]/g, '');
      if (w.length >= 3 && w[0] === w[0].toUpperCase() && w[0] !== w[0].toLowerCase()) {
        // Juntar atÃ© 3 palavras consecutivas com maiÃºscula para pegar nome completo
        let name = w;
        if (i+1 < words.length) {
          const w2 = words[i+1].replace(/[^a-zA-ZÃ€-Ãº]/g, '');
          if (w2.length >= 2 && w2[0] === w2[0].toUpperCase()) name += ' ' + w2;
        }
        names.push(name);
      }
    }
    return [...new Set(names)];
  }

  // Busca direta por nome na base
  function findByName(name, speakers) {
    const n = name.toLowerCase();
    return speakers.filter(s => (s['Nome'] || '').toLowerCase().includes(n));
  }

  // â”€â”€â”€ OPENROUTER CALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function callAI(userMessage) {
    const speakers = await loadSpeakers();

    // Busca pela mensagem atual + histÃ³rico recente
    const searchText = [userMessage, ...history.slice(-4).map(h => h.parts[0].text)].join(' ');
    var relevant = searchSpeakers(searchText, speakers);

    // Busca especÃ­fica por nomes prÃ³prios mencionados
    const properNames = extractProperNames(userMessage);
    properNames.forEach(name => {
      const found = findByName(name, speakers);
      found.forEach(s => {
        if (!relevant.find(r => r.Nome === s.Nome)) relevant.push(s);
      });
    });

    // Se nÃ£o achou nada relevante, manda amostra aleatÃ³ria para o modelo nÃ£o alucinar
    if (relevant.length === 0) {
      relevant = [...speakers].sort(() => 0.5 - Math.random()).slice(0, 15);
    }

    const speakerContext = `\n\nâš ï¸ REGRAS CRÃTICAS SOBRE DADOS:\n1. VocÃª SOMENTE pode sugerir palestrantes cujo NOME apareÃ§a exatamente na lista abaixo.\n2. O CACHE que vocÃª informar DEVE ser exatamente o valor CACHE EXATO DA BASE da lista â€” nunca invente, estime ou arredonde sem ter o valor na lista.\n3. Se o campo cache estiver vazio, diga que irÃ¡ buscar o valor e retornar por email.\n4. NUNCA cite um palestrante que nÃ£o esteja nesta lista.\n\nPALESTRANTES DISPONÃVEIS NA BASE:\n` +
      relevant.map(formatSpeaker).join('\n');

    const systemWithContext = SYSTEM_PROMPT + speakerContext;


    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system: systemWithContext,
        messages: [
          ...history.map(h => ({ role: h.role === 'model' ? 'assistant' : h.role, content: h.parts[0].text })),
          { role: 'user', content: userMessage }
        ]
      })
    });

    const json = await res.json();
    if (!res.ok) throw new Error(json.error || 'API error');
    return json.content || 'Desculpe, nÃ£o consegui gerar uma resposta.';
  }

  // â”€â”€â”€ EMAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendEmail(summary) {
    try {
      await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, {
        message: summary,
        to_email: 'palestras@efeitovirgula.com.br'
      });
      console.log('Email enviado com sucesso');
    } catch (e) {
      console.error('Erro ao enviar email:', e);
    }
  }

  // â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const chatArea = document.getElementById('chatArea');
  const welcome  = document.getElementById('welcome');
  const input    = document.getElementById('userInput');
  const sendBtn  = document.getElementById('sendBtn');

  function removeWelcome() {
    if (welcome && welcome.parentNode) {
      welcome.remove();
      document.getElementById('restartBtn').style.display = 'block';
    }
  }

  window.restartChat = function() {
    history = [];
    speakerCache = null;
    chatArea.innerHTML = '';
    const welcomeDiv = document.createElement('div');
    welcomeDiv.id = 'welcome';
    welcomeDiv.className = 'welcome';
    welcomeDiv.innerHTML = `
      <div class="welcome-icon">ðŸŽ¤</div>
      <h1>Encontre o palestrante <span>ideal</span></h1>
      <p>Sou seu consultor de palestras. Me conte sobre seu evento e vou sugerir os melhores palestrantes para o seu objetivo e orÃ§amento.</p>
      <div class="suggestion-chips">
        <div class="chip" onclick="sendChip(this)">Preciso de um palestrante motivacional</div>
        <div class="chip" onclick="sendChip(this)">Evento para empresa em SÃ£o Paulo</div>
        <div class="chip" onclick="sendChip(this)">SugestÃµes para datas especiais</div>
        <div class="chip" onclick="sendChip(this)">Bons palestrantes atÃ© R$ 30.000</div>
      </div>`;
    chatArea.appendChild(welcomeDiv);
    document.getElementById('restartBtn').style.display = 'none';
    input.value = '';
    input.focus();
  }

  function appendMessage(role, text) {
    removeWelcome();
    const div = document.createElement('div');
    div.className = `message ${role}`;
    const av = document.createElement('div');
    av.className = `avatar ${role === 'user' ? 'user-av' : 'ai'}`;
    av.textContent = role === 'user' ? 'V' : 'PI';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = formatText(text);
    div.appendChild(av);
    div.appendChild(bubble);
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
    return div;
  }

  function showTyping() {
    removeWelcome();
    const div = document.createElement('div');
    div.className = 'typing';
    div.id = 'typing';
    div.innerHTML = `
      <div class="avatar ai">PI</div>
      <div class="typing-dots"><span></span><span></span><span></span></div>`;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function hideTyping() {
    const t = document.getElementById('typing');
    if (t) t.remove();
  }

  function formatText(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/##SEND_EMAIL##[\s\S]*?##END_EMAIL##/g, '')
      .replace(/\n/g, '<br>');
  }

  // â”€â”€â”€ SEND MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.sendMessage = async function() {
    const text = input.value.trim();
    if (!text || sendBtn.disabled) return;

    input.value = '';
    input.style.height = 'auto';
    sendBtn.disabled = true;

    appendMessage('user', text);
    showTyping();

    try {
      const response = await callAI(text);

      // Check for email trigger
      const emailMatch = response.match(/##SEND_EMAIL##([\s\S]*?)##END_EMAIL##/);
      if (emailMatch) {
        await sendEmail(emailMatch[1].trim());
      }

      hideTyping();
      const cleanResponse = response.replace(/##SEND_EMAIL##[\s\S]*?##END_EMAIL##/, '').trim();
      appendMessage('ai', cleanResponse);

      // Update history
      history.push({ role: 'user', parts: [{ text }] });
      history.push({ role: 'model', parts: [{ text: cleanResponse }] });

    } catch (err) {
      hideTyping();
      appendMessage('ai', 'Ops, ocorreu um erro ao processar sua mensagem. Por favor, tente novamente.');
      console.error(err);
    }

    sendBtn.disabled = false;
    input.focus();
  }

  window.sendChip = function(chip) {
    input.value = chip.textContent;
    sendMessage();
  }

  // Auto-resize textarea
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 140) + 'px';
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
</script>
</body>
</html>
